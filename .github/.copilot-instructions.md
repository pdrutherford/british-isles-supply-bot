# Copilot Project Instructions

Concise context for generating code in this repo.

## Purpose

Automated daily supply tracking for tabletop campaign armies. Reads configured Google Sheets cells, decrements current supplies by daily consumption, updates the sheet (unless already zero), and posts status / warning / zero-supply embeds to Discord via webhooks. Runs locally (manual) or on a scheduled GitHub Action.

## Tech & Structure

- Runtime: Node.js (CommonJS). Entry: `src/index.js`.
- Services:
  - `GoogleSheetsService`: Auth via service account (JWT), batch + single cell read/update helpers, sheet validation.
  - `DiscordNotifier`: Builds status / warning / critical / zero / error embeds & posts via HTTPS webhook.
- Utilities:
  - `config.js`: Loads & validates sheet config (env or file).
  - `logger.js`: Central logger with CI sanitization.
- Script: `scripts/validate-sheets.js` validates all sheet configs & cell accessibility using rate limiting + exponential backoff.

## Core Logic (index.js)

1. Load config array of sheet definitions.
2. For each sheet (spaced by sleeps):
   - Batch read current supplies + daily consumption cells.
   - Parse numeric (allow commas).
   - Compute new supplies = max(0, current - daily).
   - Update sheet only if previous value > 0.
   - Determine zero / normal path and daysRemaining = floor(new / daily).
   - Send appropriate Discord notification or error embed.
3. Rate limiting: 2–5s stagger + batchGet to reduce quota.

## Configuration (per sheet object)

Required fields: `name`, `sheetId`, `webhookUrl`, `currentSuppliesCell`, `dailyConsumptionCell`. Optional: `sheetName` (tab). Cell addresses must match /^[A-Z]+[1-9][0-9]\*$/.

## Environment Variables

- `GOOGLE_SERVICE_ACCOUNT_KEY` (base64 JSON) OR `GOOGLE_SERVICE_ACCOUNT_PATH` (local file) for Sheets auth.
- `SHEETS_CONFIG` (JSON array) OR `SHEETS_CONFIG_PATH` (defaults `./config/sheets.json`).
- `LOG_LEVEL` (debug|info|warn|error; default info).
- `GITHUB_ACTIONS` (auto set in CI; triggers sensitive data sanitization).

## Logging & Sanitization

Always use the provided `logger` (debug/info/warn/error). In GitHub Actions, messages matching supply/tactical patterns are sanitized (numbers → X, phrasing generalized) while preserving level + operational context. Do NOT bypass with raw `console.*` for supply-sensitive content. When adding new supply-related text, prefer neutral wording or extend sanitization patterns if needed.

## Quota / Performance Guidelines

- Prefer batch operations (`getCellValuesBatch`) when reading multiple cells.
- Add modest delays between sheets; reuse existing sleep helper.
- Use exponential backoff for quota errors (see validate script pattern) when introducing new API loops.

## Discord Notifications

Embed fields: Current Day (NY tz), Current Supplies, Daily Consumption, Days Remaining, Zero Supplies Date. Prepending content line for warnings (<=7 days) and urgent (<=3 or zero). Extend consistently via helper methods (maintain color/emoji logic in `DiscordNotifier`).

## Style & Conventions

- CommonJS modules (require/module.exports).
- Classes: PascalCase; functions/vars: camelCase.
- Avoid introducing global state; instantiate services per run.
- Validate all external input (env / config) early; throw descriptive errors.
- Keep new numeric parsing consistent with `parseNumericValue`.

## Error Handling

- Catch per-sheet errors; still continue others.
- Send error embed via `DiscordNotifier.sendError` with sheet name + message.
- Fatal setup errors exit with code 1.

## Adding Features (Examples)

When implementing:

- New sheet metrics: batch read additional cells; guard null; update config validation if required fields grow.
- Additional notification tiers: adjust `getStatusColor`, `getStatusEmoji`, and content builder; ensure logger messages sanitize.
- Command line flags: parse early, before services init; reflect in logging.

## Security Notes

- Never log raw webhook URLs or private keys; rely on logger sanitization but still avoid explicit inclusion.
- Do not embed secret material into code comments.

## Testing / Validation

- Use `npm run validate` to dry-run sheet access (reads only) with extensive logging (sanitized in CI).
- Manual functional test: `npm start` (mutates sheets + sends webhooks).

Keep responses & generated code concise, reuse existing helpers, and prioritize readability + quota efficiency.
