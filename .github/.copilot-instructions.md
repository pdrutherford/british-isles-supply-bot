# Copilot Project Instructions

Concise context for generating code in this repo.

## Purpose

Automated daily supply tracking for tabletop campaign armies. Reads configured Google Sheets cells, decrements current supplies by daily consumption (unless resting), updates the sheet (unless already zero), and posts status / warning / critical / zero-supply / error embeds to Discord via webhooks. Includes capacity monitoring & optional extended stats.

## Tech & Structure

- Runtime: Node.js (CommonJS). Entry: `src/index.js`.
- Services:
  - `GoogleSheetsService`: Auth via service account (JWT), batch + single cell read/update helpers, sheet validation.
  - `DiscordNotifier`: Builds status / resting / warning / critical / zero / error embeds & posts via HTTPS webhook.
- Utilities:
  - `config.js`: Loads & validates sheet config (env or file) including required & optional cell addresses.
  - `logger.js`: Central logger with CI sanitization (GitHub Actions) for tactical security.
- Script: `scripts/validate-sheets.js` validates all sheet configs & cell accessibility using rate limiting + exponential backoff.

## Core Logic (index.js)

For each sheet:

1. Batch read required + optional cells.
2. Parse numeric values (commas allowed) via `parseNumericValue`.
3. Determine resting status (boolean/checkbox or truthy string).
4. If not resting & supplies > 0, decrement by daily consumption (min 0) and update sheet.
5. Determine zero-supply scenario (already zero vs just hit zero) and daysRemaining (floor(current/daily)).
6. Build extended metrics (loot, morale, army length, forced march days, shipping status, supply ship count).
7. Compute overCapacity = totalCarried > carryingCapacity; include alert if true.
8. Send appropriate Discord embed (zero vs status) or error embed; continue loop on errors.
9. Sleep between sheets (3s + 2s) to reduce API quota usage.

## Configuration

Required per sheet: `name`, `sheetId`, `webhookUrl`, `currentSuppliesCell`, `dailyConsumptionCell`, `totalCarriedCell`, `currentCarryingCapacityCell`.

Optional: `sheetName`, `restingStatusCell`, `ownedAndCarriedLootCell`, `paidAndCarriedLootCell`, `currentMoraleCell`, `restingMoraleCell`, `armyLengthCell`, `forcedMarchDaysCell`, `shippingStatusCell`, `supplyShipsCountCell`.

Cell addresses must match /^[A-Z]+[1-9][0-9]\*$/.

## Environment Variables

- `GOOGLE_SERVICE_ACCOUNT_KEY` (base64 JSON) OR `GOOGLE_SERVICE_ACCOUNT_PATH` (local file).
- `SHEETS_CONFIG` (JSON array) OR `SHEETS_CONFIG_PATH` (default `./config/sheets.json`).
- `LOG_LEVEL` (debug|info|warn|error; default info).
- `GITHUB_ACTIONS` (auto in CI; toggles sanitization).

## Logging & Sanitization

Always use `logger`. In CI, supply numbers, tactical phrases, and webhook URLs get sanitized (numbers -> X, phrasing generalized) while preserving log levels. When adding new sensitive phrases, extend regex lists in `logger.containsSensitiveData` / `sanitizeMessage`.

## Discord Embeds

Shared layout uses rows with auto-padding to fill 3 inline columns. Fields added only if value present. Title prefix & color depend on days remaining; resting appends `(Resting)`. Zero supplies gets separate method with explicit 0 formatting. Capacity alert added as a non-inline field when over capacity.

Thresholds (daysRemaining):

- > =15: Green ‚úÖ
- 8-14: Yellow ‚ö°
- 4-7: Orange ‚ö†Ô∏è
- 1-3: Red üö®
- 0: Critical üö® (zero supplies path)

## Style & Conventions

- CommonJS (require/module.exports).
- Avoid duplication; reuse helper functions.
- Keep numeric parsing consistent.
- Null/undefined/empty string checks before including optional fields.
- When adding new optional metrics: extend config validation optionalCells & batch fetch list.

## Error Handling

Per-sheet try/catch. On error: log, attempt Discord error embed (sheet name, short message), continue processing remaining sheets. Fatal top-level errors exit(1).

## Performance / Quota

Use batchGet (`getCellValuesBatch`) for fetching many cells. Rate limiting via explicit sleeps. For new loops or retries, replicate exponential backoff pattern from `validate-sheets.js`.

## Security Notes

Do not log raw secrets (webhooks, private keys). Rely on sanitization but still avoid explicit inclusion. Avoid printing entire config objects if they could grow to include sensitive numerical forecasts.

## Adding Features

- New metric: add optional cell key to validation + fetch list, pass to notifier, include field conditionally.
- New alert tier: adjust `getStatusColor`, `getStatusEmoji`, & message build logic.
- Alternate time zones: create helper similar to `getCurrentDayNY` (use date-fns-tz) & parameterize.

## Testing

- `npm run validate` reads cells (sanitized in CI) without mutations.
- `npm start` mutates supplies (except resting/zero) & sends webhooks.

Keep generated code concise, factor shared logic, and preserve existing public API & behaviors unless change explicitly requested.
